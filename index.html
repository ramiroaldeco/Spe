<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votación de Carrozas</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#f7f7f8; color:#222; }
    header { background:#111; color:#fff; padding:16px; text-align:center; }
    main { max-width:720px; margin:24px auto; background:#fff; border-radius:12px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.07); }
    h1 { margin:0 0 8px }
    .options { display:grid; gap:12px; margin:16px 0; }
    .card { border:1px solid #eee; border-radius:10px; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    button { padding:10px 14px; border:none; border-radius:8px; background:#007bff; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .bar { height:10px; background:#e9ecef; border-radius:999px; overflow:hidden; }
    .fill { height:100%; width:0%; background:#007bff; transition:width .4s ease; }
    .row { display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .muted { color:#666; font-size:.9rem }
    .ok { color:#0a7b0a; font-weight:600 }
    .err { color:#b00020; font-weight:600 }
  </style>
</head>
<body>
  <header>
    <h1>Votación de Carrozas</h1>
    <div class="muted">Escaneá el QR, elegí tu favorita. 1 voto por persona.</div>
  </header>

  <main>
    <div id="status" class="muted">Cargando…</div>
    <div class="options" id="options"></div>
    <div id="results"></div>
  </main>

  <script>
    const $options = document.getElementById('options');
    const $status  = document.getElementById('status');

    let options = [];
    let yaVote = false;

    async function fetchJSON(url, opts) {
      const res = await fetch(url, { credentials: 'include', ...opts });
      if (!res.ok) throw new Error((await res.json().catch(()=>({}))).error || 'Error');
      return res.json();
    }

    function renderOptions() {
      $options.innerHTML = '';
      for (const o of options) {
        const card = document.createElement('div');
        card.className = 'card';
        const btn = document.createElement('button');
        btn.textContent = 'Votar';
        btn.disabled = yaVote;
        btn.onclick = async () => {
          btn.disabled = true;
          try {
            await fetchJSON('/api/vote', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ optionId: o.id })
            });
            yaVote = true;
            setStatus('¡Voto registrado! ✅', 'ok');
            // deshabilitar todos los botones
            document.querySelectorAll('button').forEach(b => b.disabled = true);
          } catch (e) {
            setStatus(e.message || 'No se pudo votar', 'err');
            btn.disabled = yaVote;
          }
        };

        const label = document.createElement('div');
        label.textContent = o.label;

        card.appendChild(label);
        card.appendChild(btn);
        $options.appendChild(card);
      }
    }

    function setStatus(text, cls='muted') {
      $status.className = cls;
      $status.textContent = text;
    }

    function renderResults(counts) {
      const total = counts.reduce((a,c) => a + (c.count||0), 0);
      const container = document.getElementById('results');
      container.innerHTML = '';
      counts.forEach(c => {
        const pct = total ? Math.round((c.count / total) * 100) : 0;
        const row = document.createElement('div');
        row.style.marginTop = '10px';
        row.innerHTML = `
          <div class="row">
            <div><strong>${c.label}</strong></div>
            <div class="muted">${c.count} voto(s) — <strong>${pct}%</strong></div>
          </div>
          <div class="bar"><div class="fill" style="width:${pct}%;"></div></div>
        `;
        container.appendChild(row);
      });
      if (total === 0) setStatus('Aún no hay votos. ¡Sé el primero!', 'muted');
      else if (!yaVote) setStatus('Elegí tu carroza y votá.', 'muted');
    }

    async function init() {
      try {
        options = await fetchJSON('/api/options');
        renderOptions();
        const counts = await fetchJSON('/api/results');
        renderResults(counts);

        // Conectarse al stream SSE para tiempo real
        const es = new EventSource('/events', { withCredentials: true });
        es.onmessage = (ev) => {
          try {
            const { type, payload } = JSON.parse(ev.data);
            if (type === 'counts') renderResults(payload);
          } catch {}
        };
        es.onerror = () => setStatus('Conexión en tiempo real inestable…', 'muted');

        setStatus('Conectado', 'muted');
      } catch (e) {
        setStatus('No se pudo cargar la votación', 'err');
      }
    }
    init();
  </script>
</body>
</html>
